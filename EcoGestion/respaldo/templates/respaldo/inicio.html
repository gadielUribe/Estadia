{% extends "base.html" %}
{% load static %}

{% block title %}Respaldos de Base de Datos{% endblock %}

{% block extra_css %}
  <link href="{% static 'css/list_view.css' %}" rel="stylesheet">
  <link href="{% static 'css/backup.css' %}" rel="stylesheet">
{% endblock %}


{% block content %}

<div class="list-header">
  <h2>Respaldos de Base de Datos</h2>
</div>

{% if messages %}
  <ul class="list-unstyled mb-4">
    {% for m in messages %}
      <li class="alert alert-custom {% if m.tags %}alert-{{ m.tags }}{% else %}alert-info{% endif %}">{{ m }}</li>
    {% endfor %}
  </ul>
{% endif %}

<div class="action-card">
  <div class="action-bar">
    
    <form method="post" action="{% url 'backup_now' %}">
      {% csrf_token %}
      <button class="btn-new-item">Crear respaldo ahora</button>
    </form>

    <form method="post" action="{% url 'restore_latest' %}" onsubmit="return confirm('Esto restaurará la BD con el último respaldo. ¿Continuar?');">
      {% csrf_token %}
      <button class="btn-restore">Restaurar último</button>
    </form>

    <form method="post" action="{% url 'upload' %}" enctype="multipart/form-data" class="upload-group ms-auto">
      {% csrf_token %}
      <input type="file" name="file" required class="form-control">
      <button class="btn-cancel">Subir</button> 
    </form>

  </div>
</div>

<h5 class="mt-4">Archivos .sql disponibles</h5>
<div class="table-wrapper table--1">
  <div class="table-responsive-wrapper">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Nombre del respaldo</th>
          <th>Tamaño</th>
          <th>Fecha y hora</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for f in files %}
          <tr>
            <td class="fw-semibold">{{ f.name }}</td>
            <td>{{ f.size|filesizeformat }}</td>
            <td>{{ f.mtime_str }}</td>
            <td class="table-actions">
              <a class="btn btn-sm btn-outline-success" href="{% url 'download' f.name %}">Descargar</a>
              <form method="post" action="{% url 'restore_file' f.name %}" onsubmit="return confirm('¿Restaurar {{ f.name }}? Esta acción es irreversible.');">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger">Restaurar</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="4" class="text-center p-4">No hay respaldos en la carpeta configurada.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<h5 class="mt-5">Log de eventos (auditoría)</h5>
<div class="table-wrapper table--1">
  <div class="table-responsive-wrapper">
    <table class="table table-sm">
      <thead class="table-light">
        <tr>
          <th>Fecha y hora</th>
          <th>Acción</th>
          <th>Nombre del respaldo</th>
          <th>Usuario</th>
          <th style="width: 40%;">Log (últimas líneas)</th>
        </tr>
      </thead>
      <tbody>
        {% for a in audits %}
          <tr>
            <td>{{ a.run_at|date:"Y-m-d H:i" }}</td>
            <td>{{ a.get_action_display }}</td>
            <td class="fw-semibold">{{ a.filename }}</td>
            <td>
              {% if a.user %}
                {{ a.user.nombre_completo }}
              {% else %}-{% endif %}
            </td>
            <td><div class="log-cell">{{ a.log|default:"" }}</div></td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="text-center p-4">Sin eventos registrados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}