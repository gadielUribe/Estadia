{% extends "base.html" %}
{% load static %}

{% block title %}Calendario de Mantenimiento{% endblock %}

{% block extra_css %}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
  
  <link href="{% static 'css/list_view.css' %}" rel="stylesheet">
  <link href="{% static 'css/calendar_view.css' %}" rel="stylesheet">
{% endblock %}


{% block content %}

<div class="list-header">
  <h2>Calendario de Mantenimiento</h2>
</div>

<div class="calendar-wrapper">
  <div id="calendar"></div>
</div>

<div id="day-modal" class="calendar-modal hidden">
  <div class="calendar-modal-content">
    
    <div class="calendar-modal-header">
      <h5 id="day-title">Tareas del día</h5>
      <button id="day-close" class="modal-close-btn">×</button>
    </div>
    
    <div id="day-body" class="calendar-modal-body">
      </div>
    
    <div class="calendar-modal-footer">
      <a id="add-tarea" class="btn-save" href="#">Añadir tarea</a>
    </div>
    
  </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<script>
  // Variables de Django (sin cambios)
  const USER_ROLE = "{{ user_role }}";
  const CAN_EDIT = {{ can_edit|yesno:"true,false" }};
  const CAN_MARK_DONE = {{ can_mark_done|yesno:"true,false" }};

  // getCookie (sin cambios)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    
    // Funciones de ayuda (sin cambios)
    function pad(n){ return (n<10?'0':'')+n }
    function ymdLocal(d){
      try{ return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate()); }catch(e){ return '' }
    }
    function hhmm(d){
      try{ return pad(d.getHours())+":"+pad(d.getMinutes()); }catch(e){return ''}
    }

    // Lógica del Modal (sin cambios, pero ahora apunta a las nuevas clases)
    const modal = document.getElementById('day-modal');
    const modalClose = document.getElementById('day-close');
    const modalContent = modal.querySelector('.calendar-modal-content');
    
    modalClose.addEventListener('click', ()=> { modal.classList.add('hidden'); document.body.style.overflow='';});
    modal.addEventListener('click', ()=> { modal.classList.add('hidden'); document.body.style.overflow='';});
    modalContent.addEventListener('click', (e)=> { e.stopPropagation(); });

    // Inicialización de FullCalendar (sin cambios)
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
      },
      locale: 'es',
      buttonText: { // Textos en español
        today:    'Hoy',
        month:    'Mes',
        week:     'Semana',
        day:      'Día',
        list:     'Lista'
      },
      navLinks: true,
      selectable: false,
      editable: CAN_EDIT,
      eventSources: [
        {
          url: '{% url "calendario:tareas_feed" %}',
          method: 'GET'
        }
      ],
      
      // dateClick (Lógica interna actualizada para usar nuevas clases)
      dateClick: function(info){
        const dateStr = info.dateStr; // YYYY-MM-DD
        const events = calendar.getEvents().filter(ev => ev.start && ymdLocal(ev.start) === dateStr);
        const body = document.getElementById('day-body');
        body.innerHTML = '';
        const title = document.getElementById('day-title');
        title.textContent = `Tareas del ${dateStr}`;

        if (events.length === 0){
          body.innerHTML = '<p>No hay tareas programadas.</p>';
        } else {
          // Usamos la nueva clase de lista
          const ul = document.createElement('ul');
          ul.className = 'task-list';

          events.forEach(ev => {
            const li = document.createElement('li');
            li.className = 'task-item'; // Nueva clase
            
            const p = ev.extendedProps || {};
            const resp = p.responsable ? ` - Encargado: ${p.responsable}` : '';
            li.textContent = `${hhmm(ev.start)} [${p.tipo}] ${p.planta_nombre || ev.title}${resp}`;
            
            if (p.estado === 'realizada') {
              li.classList.add('is-done');
            } else if (p.vencida) {
              li.classList.add('is-overdue');
            }
            
            if (p.estado === 'realizada'){
              const done = document.createElement('span');
              done.textContent = 'Realizada';
              done.className = 'badge-task-done'; // Nueva clase de insignia
              li.appendChild(done);
            } else if (p.puedeMarcar){
              const btn = document.createElement('button');
              btn.textContent = 'Marcar realizada';
              btn.className = 'btn-cancel'; // Reutilizamos estilo de botón
              btn.style.marginLeft = '8px';

              const formDiv = document.createElement('div');
              formDiv.className = 'task-mark-form hidden'; // Nueva clase de form
              formDiv.innerHTML = `
                <div>
                  <label style="display:block;margin-bottom:4px;font-weight:500;">Observaciones (opcional):</label>
                  <textarea rows="2"></textarea>
                  <div class="task-mark-form-actions">
                    <button class="btn-cancel" type="button">Cancelar</button>
                    <button class="btn-save" type="button">Confirmar</button>
                  </div>
                </div>`;

              btn.addEventListener('click', ()=>{
                formDiv.classList.remove('hidden');
                const ta = formDiv.querySelector('textarea');
                if (ta) ta.focus();
              });

              const [cancelBtn, confirmBtn] = formDiv.querySelectorAll('button');
              cancelBtn.addEventListener('click', ()=>{
                formDiv.classList.add('hidden');
              });
              confirmBtn.addEventListener('click', async ()=>{
                const obs = formDiv.querySelector('textarea').value || '';
                const res = await fetch(`{% url 'calendario:tarea_done' 0 %}`.replace('/0/', '/' + ev.id + '/'), {
                  method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')},
                  body: new URLSearchParams({observaciones: obs})
                });
                if (res.ok){
                  li.classList.remove('is-overdue');
                  li.classList.add('is-done');
                  if (btn) btn.remove();
                  formDiv.remove();
                  const done = document.createElement('span');
                  done.textContent = 'Realizada';
                  done.className = 'badge-task-done';
                  li.appendChild(done);
                  calendar.refetchEvents();
                } else {
                  alert('No se pudo marcar');
                }
              });

              li.appendChild(btn);
              li.appendChild(formDiv);
            }
            ul.appendChild(li);
          });
          body.appendChild(ul);
        }

        // Lógica de "Añadir tarea" (sin cambios)
        document.getElementById('add-tarea').href = `{% url 'mantenimiento:tarea_create' %}?fecha=${dateStr}`;
        modal.classList.remove('hidden');
        document.body.style.overflow='hidden';
      },
      
      // eventClick (sin cambios)
      eventClick: function(info) {
        if (info && info.jsEvent) info.jsEvent.preventDefault();
        return false;
      }
    });
    calendar.render();
  });
</script>
{% endblock %}